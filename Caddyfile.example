# Single host; path-based routing; Tailscale certs mounted by Docker at /etc/certs
{$TS_NODE} {
  # Use the Tailscale-issued certs generated by `tailscale cert`
  tls /etc/certs/{$TS_NODE}.crt /etc/certs/{$TS_NODE}.key

  # Immich under /immich
  handle_path /immich/* {
    uri strip_prefix /immich
    reverse_proxy {env.IMMICH_UPSTREAM} {
      header_up Host {http.request.host}
    }
  }

  # PhotoPrism under /prism
  handle /prism {
    redir /prism/ 302
  }

  @prism path /prism/*
  handle @prism {
    reverse_proxy {env.PHOTOPRISM_UPSTREAM} {
      header_up Host {http.request.host}
    }
  }

  @root path /
  handle @root {
    respond "OK: try /immich or /prism" 200
  }
}
